name: Nightly Release
on:
  workflow_dispatch:
  schedule:
    - cron: 0 0 * * *

jobs:
  check:
    name: Check for new commits
    runs-on: ubuntu-latest
    outputs:
      new_commits: ${{ steps.commit_check.outputs.new_commits }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check for new commits since last nightly
        id: commit_check
        run: |
          if git rev-parse nightly >/dev/null 2>&1; then
            if [ -z "$(git log nightly..HEAD --oneline)" ]; then
              echo "No new commits since last nightly release, skipping."
              echo "new_commits=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "new_commits=true" >> "$GITHUB_OUTPUT"

  nightly:
    name: Nightly build
    needs: check
    if: needs.check.outputs.new_commits == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6
      - uses: extractions/setup-just@v3
      - uses: erlef/setup-beam@v1
        with:
          otp-version: "27.3.4.1"
          elixir-version: "1.17.3"
          version-type: strict
      - uses: mlugg/setup-zig@v2
        with:
          version: "0.15.2"

      - run: just deps expert
      - run: just deps engine
      - name: Set release version to latest rev
        run: sed -i "$ s/$/-$(git rev-parse --short HEAD)/" version.txt
      - run: just burrito
        env:
          MIX_ENV: prod
      - name: Create Checksum
        run: |
          cd ./apps/expert/burrito_out
          chmod +x ./*
          shasum -a 256 ./* > expert_checksums.txt
          cd ../../../
      - name: Delete previous nightly release
        run: |
          gh release delete nightly --yes || true
          git push origin :nightly || true
      - name: Create nightly release
        run: gh release create nightly --prerelease ./apps/expert/burrito_out/*
